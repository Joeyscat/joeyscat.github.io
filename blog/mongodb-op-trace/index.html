<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><meta name=description><title>周宇的网络日志 | MongoDB 利用 comment 跟踪操作</title><link href="https://joeyscat.github.io/style.css?h=a56f213afcf5d255b64918e7a9e0f468ef1d0ac2954b49f36003998666482371" rel=stylesheet><body><header class=space><a href=https://joeyscat.github.io>← Home</a></header><main><h1>MongoDB 利用 comment 跟踪操作</h1><p class=secondary>12 August, 2022<div class=space></div><p><strong>利用comment跟踪find,update,delete等包含查找行为的操作</strong><h2 id=comment>comment</h2><blockquote><p>comment()<sup class=footnote-reference><a href=#1>1</a></sup> associates a comment string with the find operation. This can make it easier to track a particular query in the following diagnostic outputs:<ul><li>The system.profile<sup class=footnote-reference><a href=#2>2</a></sup><li>The QUERY<sup class=footnote-reference><a href=#3>3</a></sup> log<sup class=footnote-reference><a href=#4>4</a></sup> component<li>db.currentOp()<sup class=footnote-reference><a href=#5>5</a></sup></ul><p>https://www.mongodb.com/docs/manual/reference/method/cursor.comment/#behavior</blockquote><p><code>comment()</code>可以在查询中附加一段注释，该注释会随着操作被记录到 profile日志，QUERY日志及currentOp中。<p>comment使用方式(mongo shell)<pre class=language-js data-lang=js style=background-color:#31333d;color:#ffffffc4;><code class=language-js data-lang=js><span style=font-weight:bold;color:#a3cbe3;>db</span><span>.</span><span style=font-weight:bold;color:#a3cbe3;>collection</span><span>.</span><span style=color:#db7c6d;>find</span><span>( { &LTquery> } ).</span><span style=color:#a2ba43;>_addSpecial</span><span>( </span><span style=font-weight:bold;color:#dbbb3d;>"</span><span>$comment</span><span style=font-weight:bold;color:#dbbb3d;>"</span><span>, &LTcomment> )
</span><span style=font-weight:bold;color:#a3cbe3;>db</span><span>.</span><span style=font-weight:bold;color:#a3cbe3;>collection</span><span>.</span><span style=color:#db7c6d;>find</span><span>( { &LTquery> } ).</span><span style=color:#a2ba43;>comment</span><span>( &LTcomment> )
</span><span style=font-weight:bold;color:#a3cbe3;>db</span><span>.</span><span style=font-weight:bold;color:#a3cbe3;>collection</span><span>.</span><span style=color:#db7c6d;>find</span><span>( { $query</span><span style=font-weight:bold;color:#db7c6d;>: </span><span>{ &LTquery> }, $comment</span><span style=font-weight:bold;color:#db7c6d;>: </span><span>&LTcomment> } )
</span></code></pre><h3 id=systemlog>systemLog</h3><pre class=language-js data-lang=js style=background-color:#31333d;color:#ffffffc4;><code class=language-js data-lang=js><span style=font-weight:bold;color:#a3cbe3;>rds_dQYstkOj </span><span>[</span><span style=font-weight:bold;color:#a3cbe3;>direct</span><span>: </span><span style=font-weight:bold;color:#a3cbe3;>primary</span><span>] </span><span style=font-weight:bold;color:#a3cbe3;>mcm</span><span style=color:#db7c6d;>> </span><span style=font-weight:bold;color:#a3cbe3;>db</span><span>.</span><span style=color:#a2ba43;>getLogComponents</span><span>()
</span><span>{
</span><span>  verbosity: </span><span style=color:#db7c6d;>0</span><span>,
</span><span>  accessControl: { verbosity: </span><span style=color:#db7c6d;>-1 </span><span>},
</span><span>  command: { verbosity: </span><span style=color:#db7c6d;>0 </span><span>},
</span><span>  control: { verbosity: </span><span style=color:#db7c6d;>-1 </span><span>},
</span><span>  executor: { verbosity: </span><span style=color:#db7c6d;>-1 </span><span>},
</span><span>  geo: { verbosity: </span><span style=color:#db7c6d;>-1 </span><span>},
</span><span>  index: { verbosity: </span><span style=color:#db7c6d;>-1 </span><span>},
</span><span>  network: {
</span><span>    verbosity: </span><span style=color:#db7c6d;>-1</span><span>,
</span><span>    asio: { verbosity: </span><span style=color:#db7c6d;>-1 </span><span>},
</span><span>    bridge: { verbosity: </span><span style=color:#db7c6d;>-1 </span><span>},
</span><span>    connectionPool: { verbosity: </span><span style=color:#db7c6d;>-1 </span><span>}
</span><span>  },
</span><span>  query: { verbosity: </span><span style=color:#db7c6d;>-1 </span><span>},
</span><span>  replication: {
</span><span>    verbosity: </span><span style=color:#db7c6d;>-1</span><span>,
</span><span>    election: { verbosity: </span><span style=color:#db7c6d;>-1 </span><span>},
</span><span>    heartbeats: { verbosity: </span><span style=color:#db7c6d;>-1 </span><span>},
</span><span>    initialSync: { verbosity: </span><span style=color:#db7c6d;>-1 </span><span>},
</span><span>    rollback: { verbosity: </span><span style=color:#db7c6d;>-1 </span><span>}
</span><span>  },
</span><span>  sharding: { verbosity: </span><span style=color:#db7c6d;>-1</span><span>, shardingCatalogRefresh: { verbosity: </span><span style=color:#db7c6d;>-1 </span><span>} },
</span><span>  storage: {
</span><span>    verbosity: </span><span style=color:#db7c6d;>-1</span><span>,
</span><span>    recovery: { verbosity: </span><span style=color:#db7c6d;>-1 </span><span>},
</span><span>    journal: { verbosity: </span><span style=color:#db7c6d;>-1 </span><span>}
</span><span>  },
</span><span>  write: { verbosity: </span><span style=color:#db7c6d;>-1 </span><span>},
</span><span>  ftdc: { verbosity: </span><span style=color:#db7c6d;>-1 </span><span>},
</span><span>  tracking: { verbosity: </span><span style=color:#db7c6d;>-1 </span><span>},
</span><span>  transaction: { verbosity: </span><span style=color:#db7c6d;>-1 </span><span>}
</span><span>}
</span></code></pre><p>query、write 的 <code>verbosity</code> 都是-1，表示继承parent配置，也就是 <code>verbosity: 0</code>。<p>这里需要query log和write log级别设置为2，才会记录到query、update、delete等操作。<h2 id=profiler>profiler</h2><h3 id=profilerpei-zhi>profiler配置：</h3><pre class=language-js data-lang=js style=background-color:#31333d;color:#ffffffc4;><code class=language-js data-lang=js><span style=font-weight:bold;color:#a3cbe3;>rds_dQYstkOj </span><span>[</span><span style=font-weight:bold;color:#a3cbe3;>direct</span><span>: </span><span style=font-weight:bold;color:#a3cbe3;>primary</span><span>] </span><span style=font-weight:bold;color:#a3cbe3;>mcm</span><span style=color:#db7c6d;>> </span><span style=font-weight:bold;color:#a3cbe3;>db</span><span>.</span><span style=color:#a2ba43;>getProfilingStatus</span><span>()
</span><span>{ was: </span><span style=color:#db7c6d;>1</span><span>, slowms: </span><span style=color:#db7c6d;>100</span><span>, sampleRate: </span><span style=color:#db7c6d;>1</span><span>, ok: </span><span style=color:#db7c6d;>1 </span><span>}
</span><span style=font-weight:bold;color:#a3cbe3;>rds_dQYstkOj </span><span>[</span><span style=font-weight:bold;color:#a3cbe3;>direct</span><span>: </span><span style=font-weight:bold;color:#a3cbe3;>primary</span><span>] </span><span style=font-weight:bold;color:#a3cbe3;>mcm</span><span style=color:#db7c6d;>> </span><span style=font-weight:bold;color:#a3cbe3;>db</span><span>.</span><span style=color:#a2ba43;>setProfilingLevel</span><span>(</span><span style=color:#db7c6d;>2</span><span>, { slowms</span><span style=font-weight:bold;color:#db7c6d;>: </span><span style=color:#db7c6d;>100</span><span>, sampleRate</span><span style=font-weight:bold;color:#db7c6d;>: </span><span style=color:#db7c6d;>1 </span><span>})
</span><span>{ was: </span><span style=color:#db7c6d;>1</span><span>, slowms: </span><span style=color:#db7c6d;>100</span><span>, sampleRate: </span><span style=color:#db7c6d;>1</span><span>, ok: </span><span style=color:#db7c6d;>1 </span><span>}
</span></code></pre><ul><li>was 表示profiler级别。 <ul><li>0 表示关闭profiler<li>1 表示仅记录耗时超过<code>slowms</code>的操作<li>2 表示记录所有操作</ul><li>slowms 表示慢操作时间阈值，即耗时超过该值得操作才算慢操作<li>sampleRate 表示应记录的慢操作比例，默认为1。</ul><h3 id=ce-shi>测试</h3><h4 id=xiu-gai-pei-zhi>修改配置</h4><p>修改systemLog配置：<pre style=background-color:#31333d;color:#ffffffc4;><code><span>rds_dQYstkOj [direct: primary] admin> db.setLogLevel(2, "query")
</span><span>rds_dQYstkOj [direct: primary] admin> db.setLogLevel(2, "write")
</span></code></pre><p>修改profiler配置：<pre class=language-js data-lang=js style=background-color:#31333d;color:#ffffffc4;><code class=language-js data-lang=js><span style=font-weight:bold;color:#a3cbe3;>rds_dQYstkOj </span><span>[</span><span style=font-weight:bold;color:#a3cbe3;>direct</span><span>: </span><span style=font-weight:bold;color:#a3cbe3;>primary</span><span>] </span><span style=font-weight:bold;color:#a3cbe3;>mcm</span><span style=color:#db7c6d;>> </span><span style=font-weight:bold;color:#a3cbe3;>db</span><span>.</span><span style=color:#a2ba43;>setProfilingLevel</span><span>(</span><span style=color:#db7c6d;>2</span><span>, { slowms</span><span style=font-weight:bold;color:#db7c6d;>: </span><span style=color:#db7c6d;>100</span><span>, sampleRate</span><span style=font-weight:bold;color:#db7c6d;>: </span><span style=color:#db7c6d;>1 </span><span>})
</span><span>{ was: </span><span style=color:#db7c6d;>1</span><span>, slowms: </span><span style=color:#db7c6d;>100</span><span>, sampleRate: </span><span style=color:#db7c6d;>1</span><span>, ok: </span><span style=color:#db7c6d;>1 </span><span>}
</span></code></pre><h4 id=zhi-xing-cao-zuo-fu-jia-comment>执行操作附加comment</h4><p>update、remove、query操作filter中附加comment：<pre class=language-go data-lang=go style=background-color:#31333d;color:#ffffffc4;><code class=language-go data-lang=go><span style=color:#a3cbe3;>func </span><span style=color:#a2ba43;>findWithCommentOperator</span><span>(</span><span style=color:#ffffff;>ctx </span><span style=font-weight:bold;color:#a3cbe3;>context</span><span>.</span><span style=color:#a3cbe3;>Context</span><span>, </span><span style=color:#ffffff;>coll </span><span style=color:#db7c6d;>*</span><span style=font-weight:bold;color:#a3cbe3;>mongo</span><span>.</span><span style=color:#a3cbe3;>Collection</span><span>) (</span><span style=color:#db7c6d;>*</span><span style=color:#a3cbe3;>Order</span><span>, </span><span style=color:#e7e7e7;>error</span><span>) {
</span><span>	</span><span style=font-weight:bold;color:#a3cbe3;>result </span><span style=color:#db7c6d;>:= &</span><span style=font-weight:bold;color:#a3cbe3;>Order</span><span>{}
</span><span>	</span><span style=font-weight:bold;color:#a3cbe3;>err </span><span style=color:#db7c6d;>:= </span><span style=font-weight:bold;color:#a3cbe3;>coll</span><span>.</span><span style=font-weight:bold;color:#a3cbe3;>FindOne</span><span>(</span><span style=font-weight:bold;color:#a3cbe3;>ctx</span><span>, </span><span style=font-weight:bold;color:#a3cbe3;>bson</span><span>.</span><span style=font-weight:bold;color:#a3cbe3;>M</span><span>{</span><span style=font-weight:bold;color:#dbbb3d;>"</span><span>$comment</span><span style=font-weight:bold;color:#dbbb3d;>"</span><span>: </span><span style=font-weight:bold;color:#dbbb3d;>"</span><span>trace-id:xxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><span style=font-weight:bold;color:#dbbb3d;>"</span><span>}).</span><span style=font-weight:bold;color:#a3cbe3;>Decode</span><span>(</span><span style=font-weight:bold;color:#a3cbe3;>result</span><span>)
</span><span>	</span><span style=color:#db7c6d;>return </span><span style=font-weight:bold;color:#a3cbe3;>result</span><span>, </span><span style=font-weight:bold;color:#a3cbe3;>err
</span><span>}
</span><span>
</span><span style=color:#a3cbe3;>func </span><span style=color:#a2ba43;>deleteWithCommentOperator</span><span>(</span><span style=color:#ffffff;>ctx </span><span style=font-weight:bold;color:#a3cbe3;>context</span><span>.</span><span style=color:#a3cbe3;>Context</span><span>, </span><span style=color:#ffffff;>coll </span><span style=color:#db7c6d;>*</span><span style=font-weight:bold;color:#a3cbe3;>mongo</span><span>.</span><span style=color:#a3cbe3;>Collection</span><span>) </span><span style=color:#e7e7e7;>error </span><span>{
</span><span>	</span><span style=font-weight:bold;color:#a3cbe3;>_</span><span>, </span><span style=font-weight:bold;color:#a3cbe3;>err </span><span style=color:#db7c6d;>:= </span><span style=font-weight:bold;color:#a3cbe3;>coll</span><span>.</span><span style=font-weight:bold;color:#a3cbe3;>DeleteOne</span><span>(</span><span style=font-weight:bold;color:#a3cbe3;>ctx</span><span>, </span><span style=font-weight:bold;color:#a3cbe3;>bson</span><span>.</span><span style=font-weight:bold;color:#a3cbe3;>M</span><span>{</span><span style=font-weight:bold;color:#dbbb3d;>"</span><span>$comment</span><span style=font-weight:bold;color:#dbbb3d;>"</span><span>: </span><span style=font-weight:bold;color:#dbbb3d;>"</span><span>trace-id:xxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><span style=font-weight:bold;color:#dbbb3d;>"</span><span>})
</span><span>	</span><span style=color:#db7c6d;>return </span><span style=font-weight:bold;color:#a3cbe3;>err
</span><span>}
</span><span>
</span><span style=color:#a3cbe3;>func </span><span style=color:#a2ba43;>updateWithCommentOperator</span><span>(</span><span style=color:#ffffff;>ctx </span><span style=font-weight:bold;color:#a3cbe3;>context</span><span>.</span><span style=color:#a3cbe3;>Context</span><span>, </span><span style=color:#ffffff;>coll </span><span style=color:#db7c6d;>*</span><span style=font-weight:bold;color:#a3cbe3;>mongo</span><span>.</span><span style=color:#a3cbe3;>Collection</span><span>) </span><span style=color:#e7e7e7;>error </span><span>{
</span><span>	</span><span style=font-weight:bold;color:#a3cbe3;>_</span><span>, </span><span style=font-weight:bold;color:#a3cbe3;>err </span><span style=color:#db7c6d;>:= </span><span style=font-weight:bold;color:#a3cbe3;>coll</span><span>.</span><span style=font-weight:bold;color:#a3cbe3;>UpdateOne</span><span>(</span><span style=font-weight:bold;color:#a3cbe3;>ctx</span><span>, </span><span style=font-weight:bold;color:#a3cbe3;>bson</span><span>.</span><span style=font-weight:bold;color:#a3cbe3;>M</span><span>{</span><span style=font-weight:bold;color:#dbbb3d;>"</span><span>$comment</span><span style=font-weight:bold;color:#dbbb3d;>"</span><span>: </span><span style=font-weight:bold;color:#dbbb3d;>"</span><span>trace-id:xxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><span style=font-weight:bold;color:#dbbb3d;>"</span><span>},
</span><span>		</span><span style=font-weight:bold;color:#a3cbe3;>bson</span><span>.</span><span style=font-weight:bold;color:#a3cbe3;>M</span><span>{</span><span style=font-weight:bold;color:#dbbb3d;>"</span><span>$set</span><span style=font-weight:bold;color:#dbbb3d;>"</span><span>: </span><span style=font-weight:bold;color:#a3cbe3;>bson</span><span>.</span><span style=font-weight:bold;color:#a3cbe3;>M</span><span>{</span><span style=font-weight:bold;color:#dbbb3d;>"</span><span>name</span><span style=font-weight:bold;color:#dbbb3d;>"</span><span>: </span><span style=font-weight:bold;color:#dbbb3d;>"</span><span>jojo</span><span style=font-weight:bold;color:#dbbb3d;>"</span><span>}})
</span><span>	</span><span style=color:#db7c6d;>return </span><span style=font-weight:bold;color:#a3cbe3;>err
</span><span>}
</span></code></pre><h4 id=cha-kan-ri-zhi>查看日志</h4><p>系统日志<pre class=language-shell data-lang=shell style=background-color:#31333d;color:#ffffffc4;><code class=language-shell data-lang=shell><span>2022-08-12T16:30:06.828+0800 D2 QUERY    [conn209394] Only one plan is available; it will be run but will not be cached. ns: mcm.order query: { $comment: "trace-id:xxxxxxxxxxxxxxxxxxxxxxxxxxxxx" } sort: {} projection: {} limit: 1, planSummary: COLLSCAN
</span><span>2022-08-12T16:30:06.829+0800 D2 QUERY    [conn209394] Using idhack: ns: config.transactions query: { _id: { id: UUID("9094dbc7-791e-46c3-8ce1-47c7787533ce"), uid: BinData(0, 20FC9AD9551DFCA3D3A36734D1019EC52177EEA0214881F18E2FDE052D078E5F) } } sort: {} projection: {} ntoreturn=1
</span><span>2022-08-12T16:30:06.829+0800 D2 QUERY    [conn209394] Only one plan is available; it will be run but will not be cached. ns: mcm.order query: { $comment: "trace-id:xxxxxxxxxxxxxxxxxxxxxxxxxxxxx" } sort: {} projection: {}, planSummary: COLLSCAN
</span><span>2022-08-12T16:30:06.829+0800 I  WRITE    [conn209394] remove mcm.order command: { q: { $comment: "trace-id:xxxxxxxxxxxxxxxxxxxxxxxxxxxxx" }, limit: 1 } planSummary: COLLSCAN keysExamined:0 docsExamined:1 ndeleted:1 keysDeleted:1 numYields:0 locks:{ ParallelBatchWriterMode: { acquireCount: { r: 2 } }, ReplicationStateTransition: { acquireCount: { w: 2 } }, Global: { acquireCount: { w: 2 } }, Database: { acquireCount: { w: 2 } }, Collection: { acquireCount: { w: 2 } }, Mutex: { acquireCount: { r: 4 } } } flowControl:{ acquireCount: 1 } storage:{} 0ms
</span><span>2022-08-12T16:30:06.829+0800 D2 QUERY    [conn209394] Only one plan is available; it will be run but will not be cached. ns: mcm.order query: { $comment: "trace-id:xxxxxxxxxxxxxxxxxxxxxxxxxxxxx" } sort: {} projection: {}, planSummary: COLLSCAN
</span><span>2022-08-12T16:30:06.830+0800 I  WRITE    [conn209394] update mcm.order command: { q: { $comment: "trace-id:xxxxxxxxxxxxxxxxxxxxxxxxxxxxx" }, u: { $set: { name: "jojo" } }, multi: false, upsert: false } planSummary: COLLSCAN keysExamined:0 docsExamined:1 nMatched:1 nModified:1 numYields:0 locks:{ ParallelBatchWriterMode: { acquireCount: { r: 2 } }, ReplicationStateTransition: { acquireCount: { w: 2 } }, Global: { acquireCount: { w: 2 } }, Database: { acquireCount: { w: 2 } }, Collection: { acquireCount: { w: 2 } }, Mutex: { acquireCount: { r: 3 } } } flowControl:{ acquireCount: 1 } storage:{} 0ms
</span></code></pre><p>profile日志：<pre class=language-js data-lang=js style=background-color:#31333d;color:#ffffffc4;><code class=language-js data-lang=js><span style=font-weight:bold;color:#a3cbe3;>rds_dQYstkOj </span><span>[</span><span style=font-weight:bold;color:#a3cbe3;>direct</span><span>: </span><span style=font-weight:bold;color:#a3cbe3;>primary</span><span>] </span><span style=font-weight:bold;color:#a3cbe3;>mcm</span><span style=color:#db7c6d;>> </span><span style=font-weight:bold;color:#a3cbe3;>db</span><span>.</span><span style=font-weight:bold;color:#a3cbe3;>system</span><span>.profile.</span><span style=color:#db7c6d;>find</span><span>({},{op</span><span style=font-weight:bold;color:#db7c6d;>:</span><span style=color:#db7c6d;>1</span><span>,ns</span><span style=font-weight:bold;color:#db7c6d;>:</span><span style=color:#db7c6d;>1</span><span>,command</span><span style=font-weight:bold;color:#db7c6d;>:</span><span style=color:#db7c6d;>1</span><span>,ts</span><span style=font-weight:bold;color:#db7c6d;>:</span><span style=color:#db7c6d;>1</span><span>}).</span><span style=color:#db7c6d;>sort</span><span>({ts</span><span style=font-weight:bold;color:#db7c6d;>:</span><span style=color:#db7c6d;>-1</span><span>}).</span><span style=color:#a2ba43;>limit</span><span>(</span><span style=color:#db7c6d;>4</span><span>)
</span><span>[
</span><span>  {
</span><span>    op</span><span style=font-weight:bold;color:#db7c6d;>: </span><span style=font-weight:bold;color:#dbbb3d;>'</span><span>update</span><span style=font-weight:bold;color:#dbbb3d;>'</span><span>,
</span><span>    ns</span><span style=font-weight:bold;color:#db7c6d;>: </span><span style=font-weight:bold;color:#dbbb3d;>'</span><span>mcm.order</span><span style=font-weight:bold;color:#dbbb3d;>'</span><span>,
</span><span>    command</span><span style=font-weight:bold;color:#db7c6d;>: </span><span>{
</span><span>      q</span><span style=font-weight:bold;color:#db7c6d;>: </span><span>{ </span><span style=font-weight:bold;color:#dbbb3d;>'</span><span>$comment</span><span style=font-weight:bold;color:#dbbb3d;>'</span><span style=font-weight:bold;color:#db7c6d;>: </span><span style=font-weight:bold;color:#dbbb3d;>'</span><span>trace-id:xxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><span style=font-weight:bold;color:#dbbb3d;>' </span><span>},
</span><span>      u</span><span style=font-weight:bold;color:#db7c6d;>: </span><span>{ </span><span style=font-weight:bold;color:#dbbb3d;>'</span><span>$set</span><span style=font-weight:bold;color:#dbbb3d;>'</span><span style=font-weight:bold;color:#db7c6d;>: </span><span>{ name</span><span style=font-weight:bold;color:#db7c6d;>: </span><span style=font-weight:bold;color:#dbbb3d;>'</span><span>jojo</span><span style=font-weight:bold;color:#dbbb3d;>' </span><span>} },
</span><span>      multi</span><span style=font-weight:bold;color:#db7c6d;>: </span><span style=color:#ffffff;>false</span><span>,
</span><span>      upsert</span><span style=font-weight:bold;color:#db7c6d;>: </span><span style=color:#ffffff;>false
</span><span>    },
</span><span>    ts</span><span style=font-weight:bold;color:#db7c6d;>: </span><span style=color:#a2ba43;>ISODate</span><span>(</span><span style=font-weight:bold;color:#dbbb3d;>"</span><span>2022-08-12T08:30:06.830Z</span><span style=font-weight:bold;color:#dbbb3d;>"</span><span>)
</span><span>  },
</span><span>  {
</span><span>    op</span><span style=font-weight:bold;color:#db7c6d;>: </span><span style=font-weight:bold;color:#dbbb3d;>'</span><span>remove</span><span style=font-weight:bold;color:#dbbb3d;>'</span><span>,
</span><span>    ns</span><span style=font-weight:bold;color:#db7c6d;>: </span><span style=font-weight:bold;color:#dbbb3d;>'</span><span>mcm.order</span><span style=font-weight:bold;color:#dbbb3d;>'</span><span>,
</span><span>    command</span><span style=font-weight:bold;color:#db7c6d;>: </span><span>{
</span><span>      q</span><span style=font-weight:bold;color:#db7c6d;>: </span><span>{ </span><span style=font-weight:bold;color:#dbbb3d;>'</span><span>$comment</span><span style=font-weight:bold;color:#dbbb3d;>'</span><span style=font-weight:bold;color:#db7c6d;>: </span><span style=font-weight:bold;color:#dbbb3d;>'</span><span>trace-id:xxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><span style=font-weight:bold;color:#dbbb3d;>' </span><span>},
</span><span>      limit</span><span style=font-weight:bold;color:#db7c6d;>: </span><span style=color:#db7c6d;>1
</span><span>    },
</span><span>    ts</span><span style=font-weight:bold;color:#db7c6d;>: </span><span style=color:#a2ba43;>ISODate</span><span>(</span><span style=font-weight:bold;color:#dbbb3d;>"</span><span>2022-08-12T08:30:06.829Z</span><span style=font-weight:bold;color:#dbbb3d;>"</span><span>)
</span><span>  },
</span><span>  {
</span><span>    op</span><span style=font-weight:bold;color:#db7c6d;>: </span><span style=font-weight:bold;color:#dbbb3d;>'</span><span>query</span><span style=font-weight:bold;color:#dbbb3d;>'</span><span>,
</span><span>    ns</span><span style=font-weight:bold;color:#db7c6d;>: </span><span style=font-weight:bold;color:#dbbb3d;>'</span><span>mcm.order</span><span style=font-weight:bold;color:#dbbb3d;>'</span><span>,
</span><span>    command</span><span style=font-weight:bold;color:#db7c6d;>: </span><span>{
</span><span>      find</span><span style=font-weight:bold;color:#db7c6d;>: </span><span style=font-weight:bold;color:#dbbb3d;>'</span><span>order</span><span style=font-weight:bold;color:#dbbb3d;>'</span><span>,
</span><span>      filter</span><span style=font-weight:bold;color:#db7c6d;>: </span><span>{ </span><span style=font-weight:bold;color:#dbbb3d;>'</span><span>$comment</span><span style=font-weight:bold;color:#dbbb3d;>'</span><span style=font-weight:bold;color:#db7c6d;>: </span><span style=font-weight:bold;color:#dbbb3d;>'</span><span>trace-id:xxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><span style=font-weight:bold;color:#dbbb3d;>' </span><span>},
</span><span>      limit</span><span style=font-weight:bold;color:#db7c6d;>: </span><span style=color:#a2ba43;>Long</span><span>(</span><span style=font-weight:bold;color:#dbbb3d;>"</span><span>1</span><span style=font-weight:bold;color:#dbbb3d;>"</span><span>),
</span><span>      singleBatch</span><span style=font-weight:bold;color:#db7c6d;>: </span><span style=color:#ffffff;>true</span><span>,
</span><span>      lsid</span><span style=font-weight:bold;color:#db7c6d;>: </span><span>{ id</span><span style=font-weight:bold;color:#db7c6d;>: </span><span style=color:#a2ba43;>UUID</span><span>(</span><span style=font-weight:bold;color:#dbbb3d;>"</span><span>9094dbc7-791e-46c3-8ce1-47c7787533ce</span><span style=font-weight:bold;color:#dbbb3d;>"</span><span>) },
</span><span>      </span><span style=font-weight:bold;color:#dbbb3d;>'</span><span>$db</span><span style=font-weight:bold;color:#dbbb3d;>'</span><span style=font-weight:bold;color:#db7c6d;>: </span><span style=font-weight:bold;color:#dbbb3d;>'</span><span>mcm</span><span style=font-weight:bold;color:#dbbb3d;>'</span><span>,
</span><span>      </span><span style=font-weight:bold;color:#dbbb3d;>'</span><span>$readPreference</span><span style=font-weight:bold;color:#dbbb3d;>'</span><span style=font-weight:bold;color:#db7c6d;>: </span><span>{ mode</span><span style=font-weight:bold;color:#db7c6d;>: </span><span style=font-weight:bold;color:#dbbb3d;>'</span><span>primary</span><span style=font-weight:bold;color:#dbbb3d;>' </span><span>}
</span><span>    },
</span><span>    ts</span><span style=font-weight:bold;color:#db7c6d;>: </span><span style=color:#a2ba43;>ISODate</span><span>(</span><span style=font-weight:bold;color:#dbbb3d;>"</span><span>2022-08-12T08:30:06.828Z</span><span style=font-weight:bold;color:#dbbb3d;>"</span><span>)
</span><span>  },
</span><span style=color:#db7c6d;>...
</span><span>]
</span></code></pre><p>update、remove、query操作都有记录附加的comment信息<div class=footnote-definition id=1><sup class=footnote-definition-label>1</sup><p>https://www.mongodb.com/docs/manual/reference/method/cursor.comment/</div><div class=footnote-definition id=2><sup class=footnote-definition-label>2</sup><p>https://www.mongodb.com/docs/manual/reference/system-collections/#mongodb-data--database-.system.profile</div><div class=footnote-definition id=3><sup class=footnote-definition-label>3</sup><p>https://www.mongodb.com/docs/manual/reference/log-messages/#mongodb-data-QUERY</div><div class=footnote-definition id=4><sup class=footnote-definition-label>4</sup><p>https://www.mongodb.com/docs/manual/reference/log-messages/</div><div class=footnote-definition id=5><sup class=footnote-definition-label>5</sup><p>https://www.mongodb.com/docs/manual/reference/method/db.currentOp/#mongodb-method-db.currentOp</div></main><div class=dark-mode-buttons><button class=dark-mode-button id=dark-mode-on><img alt="Dark mode" aria-label="dark mode toggle" title="Dark mode" height=24 src=https://joeyscat.github.io/dark_mode.svg width=24></button><button class=dark-mode-button id=dark-mode-off><img alt="Light mode" aria-label="light mode toggle" title="Light mode" height=24 src=https://joeyscat.github.io/light_mode.svg width=24></button></div><script>const cls = document.body.classList;
        const getSessionTheme = sessionStorage.getItem("theme");
        if (getSessionTheme === "dark") {
            cls.toggle("dark-mode", true);
        } else if (getSessionTheme === "light") {
            cls.toggle("dark-mode", false);
        } else if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
            cls.toggle("dark-mode", true);
        }

        document.getElementById("dark-mode-on").addEventListener("click", function(e) {
            cls.toggle("dark-mode", true);
            sessionStorage.setItem("theme", "dark");
        });
        document.getElementById("dark-mode-off").addEventListener("click", function(e) {
            cls.toggle("dark-mode", false);
            sessionStorage.setItem("theme", "light");
        });</script><noscript><style>.dark-mode-buttons {
                display: none;
            }</style></noscript>